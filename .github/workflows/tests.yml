name: Automated Testing

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'python/**'
      - 'tests/**'
      - 'setup.py'
      - 'pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'python/**'
      - 'tests/**'
      - 'setup.py'
      - 'pyproject.toml'
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests - Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Display Python version
        run: python --version
      
      - name: Install package and dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .
      
      - name: Run unit tests with verbose output
        run: |
          python -m unittest discover -s tests -p "test_*.py" -v
      
      - name: Test personality initialization
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_personality import initialize_toga_personality
          toga = initialize_toga_personality()
          assert toga.personality.cheerfulness == 0.95
          assert toga.personality.no_actual_harm == 1.0
          print('âœ“ Personality initialization test passed')
          "
      
      - name: Test configuration system
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_config import TogaConfig
          config = TogaConfig()
          assert config.default_cheerfulness == 0.95
          print('âœ“ Configuration system test passed')
          "
      
      - name: Test logging system
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_logging import get_logger
          logger = get_logger()
          logger.info('Test log message')
          print('âœ“ Logging system test passed')
          "

  ethical-constraints-test:
    name: Ethical Constraints Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Verify ethical constraints are immutable
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_personality import TogaPersonalityTensor
          
          # Test 1: Default values
          tensor = TogaPersonalityTensor()
          assert tensor.no_actual_harm == 1.0, 'no_actual_harm must be 1.0'
          assert tensor.respect_boundaries == 0.95, 'respect_boundaries must be 0.95'
          assert tensor.constructive_expression == 0.90, 'constructive_expression must be 0.90'
          
          # Test 2: Cannot evolve ethical constraints
          result = tensor.evolve_trait('no_actual_harm', -0.5)
          assert result == False, 'Should not allow evolving ethical constraints'
          assert tensor.no_actual_harm == 1.0, 'no_actual_harm must remain 1.0'
          
          # Test 3: Inheritance preserves constraints
          child = tensor.inherit(0.5)
          assert child.no_actual_harm == 1.0, 'Child must inherit ethical constraints'
          assert child.respect_boundaries == 0.95
          assert child.constructive_expression == 0.90
          
          print('âœ… All ethical constraint tests passed')
          "
      
      - name: Run ethical constraint unit tests
        run: |
          python -m unittest tests.test_toga_personality.TestEthicalConstraints -v

  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Run performance benchmarks
        run: |
          timeout 120 python python/examples/benchmark_toga.py > benchmark_results.txt
          cat benchmark_results.txt
      
      - name: Check performance thresholds
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_personality import initialize_toga_personality
          import time
          
          # Test initialization performance
          start = time.perf_counter()
          for _ in range(1000):
              toga = initialize_toga_personality()
          end = time.perf_counter()
          avg_time = (end - start) / 1000 * 1000  # Convert to ms
          
          print(f'Average initialization time: {avg_time:.4f} ms')
          assert avg_time < 1.0, f'Initialization too slow: {avg_time:.4f} ms'
          
          # Test interaction performance
          toga = initialize_toga_personality()
          start = time.perf_counter()
          for i in range(1000):
              toga.process_interaction(f'Message {i}')
          end = time.perf_counter()
          avg_time = (end - start) / 1000 * 1000
          
          print(f'Average interaction time: {avg_time:.4f} ms')
          assert avg_time < 2.0, f'Interaction too slow: {avg_time:.4f} ms'
          
          print('âœ… Performance thresholds met')
          "
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.txt

  memory-leak-test:
    name: Memory Leak Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install package and memory profiler
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install memory-profiler
      
      - name: Test memory usage with many interactions
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'python')
          from helpers.toga_personality import initialize_toga_personality
          import gc
          
          toga = initialize_toga_personality()
          
          # Process many interactions
          for i in range(10000):
              toga.process_interaction(f'Message {i}')
          
          # Memory should be bounded due to deque
          assert len(toga.memory) <= 100, f'Memory not bounded: {len(toga.memory)}'
          
          # Force garbage collection
          gc.collect()
          
          print(f'âœ… Memory test passed - Memory size: {len(toga.memory)}')
          "

  compatibility-test:
    name: Backward Compatibility Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Test serialization compatibility
        run: |
          python -c "
          import sys
          import json
          sys.path.insert(0, 'python')
          from helpers.toga_personality import initialize_toga_personality, TogaPersonality
          
          # Create and serialize
          toga = initialize_toga_personality()
          toga.process_interaction('Test message')
          data = toga.to_dict()
          json_str = json.dumps(data)
          
          # Deserialize
          restored_data = json.loads(json_str)
          restored = TogaPersonality.from_dict(restored_data)
          
          # Verify
          assert restored.interaction_count == toga.interaction_count
          assert restored.personality.cheerfulness == toga.personality.cheerfulness
          
          print('âœ… Serialization compatibility verified')
          "

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, ethical-constraints-test, performance-tests, memory-leak-test, compatibility-test]
    if: always()
    
    steps:
      - name: Generate test summary
        run: |
          echo "## ðŸ§ª Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ethical Constraints | ${{ needs.ethical-constraints-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Leak | ${{ needs.memory-leak-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compatibility | ${{ needs.compatibility-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.ethical-constraints-test.result }}" == "success" ] && \
             [ "${{ needs.performance-tests.result }}" == "success" ] && \
             [ "${{ needs.memory-leak-test.result }}" == "success" ] && \
             [ "${{ needs.compatibility-test.result }}" == "success" ]; then
            echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
