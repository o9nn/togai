name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  formatting:
    name: Code Formatting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort autopep8
      
      - name: Check Black formatting
        run: |
          black --check --diff --color python/
      
      - name: Check isort import sorting
        run: |
          isort --check-only --diff python/
      
      - name: Generate formatting report
        if: failure()
        run: |
          echo "## ðŸŽ¨ Formatting Issues Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run the following to fix:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "black python/" >> $GITHUB_STEP_SUMMARY
          echo "isort python/" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  linting:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint pycodestyle pydocstyle
      
      - name: Run Flake8
        run: |
          flake8 python/ --count --statistics --max-line-length=100 \
            --exclude=__pycache__,.git,build,dist,.eggs \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s'
        continue-on-error: true
      
      - name: Run Pylint
        run: |
          pylint python/helpers/ python/examples/ \
            --max-line-length=100 \
            --disable=C0111,C0103,R0913,R0914 \
            --output-format=colorized
        continue-on-error: true
      
      - name: Run pycodestyle
        run: |
          pycodestyle python/ --max-line-length=100 --statistics
        continue-on-error: true

  type-checking:
    name: Type Checking
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install type checking tools
        run: |
          python -m pip install --upgrade pip
          pip install mypy pyright
      
      - name: Run mypy
        run: |
          mypy python/helpers/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true
      
      - name: Run pyright
        run: |
          pyright python/helpers/
        continue-on-error: true

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install complexity tools
        run: |
          python -m pip install --upgrade pip
          pip install radon mccabe
      
      - name: Run Radon complexity analysis
        run: |
          echo "## Cyclomatic Complexity" > complexity_report.txt
          radon cc python/ -a -s >> complexity_report.txt
          echo "" >> complexity_report.txt
          echo "## Maintainability Index" >> complexity_report.txt
          radon mi python/ -s >> complexity_report.txt
          cat complexity_report.txt
      
      - name: Check for high complexity
        run: |
          radon cc python/ -n C -s
      
      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity_report.txt

  documentation-check:
    name: Documentation Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install documentation tools
        run: |
          python -m pip install --upgrade pip
          pip install pydocstyle interrogate
      
      - name: Check docstring coverage
        run: |
          interrogate -v python/helpers/ python/examples/ \
            --fail-under=80 \
            --ignore-init-method \
            --ignore-init-module
      
      - name: Check docstring style
        run: |
          pydocstyle python/helpers/ --convention=google
        continue-on-error: true

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
      
      - name: Run Safety check
        run: |
          safety check --json || true
        continue-on-error: true
      
      - name: Run pip-audit
        run: |
          pip-audit --desc || true
        continue-on-error: true

  code-duplication:
    name: Code Duplication Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install duplication detection tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint
      
      - name: Check for code duplication
        run: |
          pylint python/ --disable=all --enable=duplicate-code --min-similarity-lines=5
        continue-on-error: true

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [formatting, linting, type-checking, complexity-analysis, documentation-check, dependency-audit, code-duplication]
    if: always()
    
    steps:
      - name: Generate quality summary
        run: |
          echo "## ðŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting | ${{ needs.formatting.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.linting.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Checking | ${{ needs.type-checking.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Complexity | ${{ needs.complexity-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplication | ${{ needs.code-duplication.result }} |" >> $GITHUB_STEP_SUMMARY
